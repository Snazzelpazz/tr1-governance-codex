{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:tolipoc:tr1:repair-dossier:c6:v1",
  "title": "TR-1 Repair Dossier (C6) Schema v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "dossier_meta",
    "bindings",
    "conditions",
    "artifacts",
    "attestations"
  ],
  "properties": {
    "dossier_meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["version", "created_utc", "prepared_by", "system_id"],
      "properties": {
        "version": { "type": "string", "const": "C6-DOSSIER-1.0" },
        "created_utc": { "type": "string", "format": "date-time" },
        "prepared_by": {
          "type": "object",
          "additionalProperties": false,
          "required": ["agent", "operator"],
          "properties": {
            "agent": { "type": "string", "description": "Tool/agent name producing the dossier." },
            "operator": { "type": "string", "description": "Human operator identifier." }
          }
        },
        "system_id": { "type": "string" },
        "notes": { "type": "string", "maxLength": 4000 }
      }
    },

    "bindings": {
      "type": "object",
      "additionalProperties": false,
      "required": ["failed_run_id", "shadow_audit_ref", "shadow_audit_hash", "calibration_rule_id"],
      "properties": {
        "failed_run_id": { "type": "string" },
        "shadow_audit_ref": { "type": "string", "description": "Artifact reference to the Shadow Audit JSON." },
        "shadow_audit_hash": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$", "description": "SHA-256 of the Shadow Audit." },
        "calibration_rule_id": { "type": "string", "description": "e.g., CAL-4.2" },
        "random_seed_policy": { "type": "string", "enum": ["FIXED", "RECORDED_PER_RUN"] }
      }
    },

    "conditions": {
      "type": "object",
      "additionalProperties": false,
      "required": ["C1", "C2", "C3", "C4", "C5"],
      "properties": {
        "C1": { "$ref": "#/$defs/condition_C1_parameter_stabilization" },
        "C2": { "$ref": "#/$defs/condition_C2_margin_recovery" },
        "C3": { "$ref": "#/$defs/condition_C3_windowed_coherence" },
        "C4": { "$ref": "#/$defs/condition_C4_remainder_compression" },
        "C5": { "$ref": "#/$defs/condition_C5_hazard_suppression" }
      }
    },

    "artifacts": {
      "type": "object",
      "additionalProperties": false,
      "required": ["before", "after", "comparisons", "raw_metrics"],
      "properties": {
        "before": { "$ref": "#/$defs/artifact_bundle" },
        "after": { "$ref": "#/$defs/artifact_bundle" },
        "comparisons": {
          "type": "array",
          "minItems": 3,
          "items": { "$ref": "#/$defs/artifact_ref" },
          "description": "Before/after deltas, overlays, and summary tables."
        },
        "raw_metrics": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/artifact_ref" },
          "description": "Machine-readable metric dumps used to compute C1â€“C5."
        }
      }
    },

    "attestations": {
      "type": "object",
      "additionalProperties": false,
      "required": ["no_expert_override", "reproducibility", "data_integrity"],
      "properties": {
        "no_expert_override": { "type": "boolean", "const": true },
        "reproducibility": {
          "type": "object",
          "additionalProperties": false,
          "required": ["pipeline_hash", "environment", "deterministic"],
          "properties": {
            "pipeline_hash": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" },
            "environment": {
              "type": "object",
              "additionalProperties": false,
              "required": ["os", "runtime", "dependencies"],
              "properties": {
                "os": { "type": "string" },
                "runtime": { "type": "string" },
                "dependencies": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "deterministic": { "type": "boolean" }
          }
        },
        "data_integrity": {
          "type": "object",
          "additionalProperties": false,
          "required": ["input_data_ref", "input_data_hash"],
          "properties": {
            "input_data_ref": { "type": "string" },
            "input_data_hash": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" },
            "provenance": { "type": "string", "maxLength": 2000 }
          }
        }
      }
    }
  },

  "$defs": {
    "artifact_ref": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ref", "sha256", "media_type"],
      "properties": {
        "ref": { "type": "string", "description": "URI/ID/path in artifact store" },
        "sha256": { "type": "string", "pattern": "^[A-Fa-f0-9]{64}$" },
        "media_type": { "type": "string", "description": "e.g., application/json, image/png" },
        "description": { "type": "string", "maxLength": 1000 }
      }
    },

    "artifact_bundle": {
      "type": "array",
      "minItems": 2,
      "items": { "$ref": "#/$defs/artifact_ref" }
    },

    "metric_with_threshold": {
      "type": "object",
      "additionalProperties": false,
      "required": ["metric_name", "measured", "threshold", "comparison", "pass"],
      "properties": {
        "metric_name": { "type": "string" },
        "measured": { "type": "number" },
        "threshold": { "type": "number" },
        "comparison": { "type": "string", "enum": ["<", "<=", ">", ">="] },
        "pass": { "type": "boolean" },
        "notes": { "type": "string", "maxLength": 1200 }
      }
    },

    "condition_common": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status", "policy", "evidence", "before_after"],
      "properties": {
        "status": { "type": "string", "enum": ["PASS", "FAIL", "INCONCLUSIVE"] },
        "policy": {
          "type": "object",
          "additionalProperties": false,
          "required": ["thresholds_frozen", "no_manual_edits"],
          "properties": {
            "thresholds_frozen": { "type": "boolean", "const": true },
            "no_manual_edits": { "type": "boolean", "const": true },
            "comments": { "type": "string", "maxLength": 1200 }
          }
        },
        "before_after": {
          "type": "object",
          "additionalProperties": false,
          "required": ["before_ref", "after_ref"],
          "properties": {
            "before_ref": { "$ref": "#/$defs/artifact_ref" },
            "after_ref": { "$ref": "#/$defs/artifact_ref" }
          }
        },
        "evidence": {
          "type": "object",
          "additionalProperties": false,
          "required": ["metrics", "plots"],
          "properties": {
            "metrics": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/metric_with_threshold" }
            },
            "plots": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/artifact_ref" }
            }
          }
        }
      }
    },

    "condition_C1_parameter_stabilization": {
      "allOf": [
        { "$ref": "#/$defs/condition_common" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["windowing", "pi_star_summary"],
          "properties": {
            "windowing": {
              "type": "object",
              "additionalProperties": false,
              "required": ["num_windows", "window_method"],
              "properties": {
                "num_windows": { "type": "integer", "minimum": 3, "maximum": 20 },
                "window_method": { "type": "string", "enum": ["EQUAL", "OVERLAPPING", "ADAPTIVE"] }
              }
            },
            "pi_star_summary": {
              "type": "object",
              "additionalProperties": false,
              "required": ["var_pi", "sigma_threshold"],
              "properties": {
                "var_pi": { "type": "number" },
                "sigma_threshold": { "type": "number" }
              }
            }
          }
        }
      ]
    },

    "condition_C2_margin_recovery": {
      "allOf": [
        { "$ref": "#/$defs/condition_common" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["margins", "gap_time_profile"],
          "properties": {
            "margins": {
              "type": "object",
              "additionalProperties": false,
              "required": ["m_delta", "m_Gamma", "m_kappa"],
              "properties": {
                "m_delta": { "type": "number" },
                "m_Gamma": { "type": "number" },
                "m_kappa": { "type": "number" }
              }
            },
            "gap_time_profile": {
              "type": "object",
              "additionalProperties": false,
              "required": ["min_g_delta", "min_g_Gamma", "min_g_kappa", "holds_for_T"],
              "properties": {
                "min_g_delta": { "type": "number" },
                "min_g_Gamma": { "type": "number" },
                "min_g_kappa": { "type": "number" },
                "holds_for_T": { "type": "boolean" }
              }
            }
          }
        }
      ]
    },

    "condition_C3_windowed_coherence": {
      "allOf": [
        { "$ref": "#/$defs/condition_common" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["coherence_metric", "C_min", "Omega_cert"],
          "properties": {
            "coherence_metric": { "type": "string", "description": "Name/definition id of coherence metric used." },
            "C_min": { "type": "number" },
            "Omega_cert": {
              "type": "object",
              "additionalProperties": false,
              "required": ["window_family", "invariance_required"],
              "properties": {
                "window_family": { "type": "string", "enum": ["EQUAL_4", "EQUAL_8", "BLOCK_80", "CUSTOM_FROZEN"] },
                "invariance_required": { "type": "boolean", "const": true }
              }
            }
          }
        }
      ]
    },

    "condition_C4_remainder_compression": {
      "allOf": [
        { "$ref": "#/$defs/condition_common" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["RB_epsilon_T", "sup_norm_R"],
          "properties": {
            "RB_epsilon_T": { "type": "number" },
            "sup_norm_R": { "type": "number" }
          }
        }
      ]
    },

    "condition_C5_hazard_suppression": {
      "allOf": [
        { "$ref": "#/$defs/condition_common" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["hazard_metric", "h_stop", "max_H_over_T"],
          "properties": {
            "hazard_metric": { "type": "string" },
            "h_stop": { "type": "number" },
            "max_H_over_T": { "type": "number" }
          }
        }
      ]
    }
  }
          }
